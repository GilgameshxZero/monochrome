"use strict";{const e=self,t=e,s=e.document;(self.webpackChunkStylus=self.webpackChunkStylus||[]).push([["install-usercss"],{6769:(e,t,s)=>{t.default='<div><span class=rel><input id=ss-updatable type=checkbox><label i18n=installUpdateFromLabel for=ss-updatable></label></span><input id=ss-update-url type=url class=w100 i18n=placeholder:styleUpdateUrlLabel></div><div id=ss-scheme><div i18n=preferScheme><div><small id=ss-scheme-off i18n=preferSchemeAlways hidden></small></div></div><label i18n=+preferSchemeNone class=radio-wrapper><input name=ss-scheme type=radio value=none></label><label i18n=+preferSchemeDark class=radio-wrapper><input name=ss-scheme type=radio value=dark></label><label i18n=+preferSchemeLight class=radio-wrapper><input name=ss-scheme type=radio value=light></label></div><label i18n=styleIncludeLabel><textarea id=ss-inclusions spellcheck=false class=w100 placeholder=*://www.aaa.com/*></textarea></label><label i18n=styleExcludeLabel><textarea id=ss-exclusions spellcheck=false class=w100 placeholder=*://www.aaa.com/*></textarea></label><div class=buttons><button id=ss-save i18n=confirmSave disabled></button>&nbsp;<label i18n="+configOnChange, title:configOnChangeTooltip"><input id=config.autosave type=checkbox></label></div>'},9050:(l,n,r)=>{r(9073);var a=r(6199),cmpver=r(9421),dom=r(7986),dom_util=r(3831),localization=r(7501),msg_api=r(4930),prefs=r(492),sections_util=r(2013),urls=r(8982),util=r(6940),util_webext=r(1480),o=r(8970);function DirectDownloader(url){const opts={headers:{"Cache-Control":"no-cache, no-store"}};let oldCode=null;return async()=>{const code=o.CHROME<99?await msg_api.API.download(url,opts):await util.fetchText(url,opts);if(oldCode!==code)return oldCode=code,code}}var style_settings=r(6769);const CFG_SEL="#message-box.config-dialog";let install_usercss_cm,fsh,fso,getData,initialUrl,style,installed,dup,liveReload,sectionsPromise,tabId,vars,cfgShown=!0,liveReloadEnabled=!1;function updateMeta(newStyle){if(newStyle){Object.assign(style,newStyle);for(const e in style)e in newStyle||delete style[e]}const data=style.usercssData,dupData=dup&&dup.usercssData,versionTest=dup&&(0,cmpver.default)(data.version,dupData.version);install_usercss_cm.setPreprocessor(data.preprocessor);const installButtonLabel=util.t(installed?"installButtonInstalled":dup?versionTest>0?"installButtonUpdate":"installButtonReinstall":"installButton");if(s.title=`${installButtonLabel} ${data.name}`,s.querySelector(".install").textContent=installButtonLabel,s.querySelector(".install").classList.add(installed?"installed":dup?versionTest>0?"update":"reinstall":"install"),dup&&dup.updateUrl&&(s.querySelector(".set-update-url").title=util.t("installUpdateFrom",dup.updateUrl).replace(/\S+$/,"\n$&")),s.querySelector(".meta-name").textContent=data.name,s.querySelector(".meta-version").textContent=data.version,s.querySelector(".meta-description").textContent=data.description,s.querySelectorAll("#ss-scheme input").forEach(e=>{e.checked=e.value===(style.preferScheme||"none")}),replaceChildren(s.querySelector(".meta-author"),function(text){const match=text&&text.match(/^(.+?)(?:\s+<(.+?)>)?(?:\s+\((.+?)\))?$/);if(!match)return text;const[,name,email,url]=match,elems=[];elems.push(email?dom.$createLink(`mailto:${email}`,name):dom.$create("span",name));url&&elems.push(dom.$createLink(url,dom.$create("i.i-external")));return elems}(data.author),!0),replaceChildren(s.querySelector(".meta-license"),data.license,!0),replaceChildren(s.querySelector(".external-link"),function(){const urls=[data.homepageURL&&[data.homepageURL,util.t("externalHomepage")],data.supportURL&&[data.supportURL,util.t("externalSupport")]];return(data.homepageURL||data.supportURL)&&dom.$create("div",[dom.$create("h3",util.t("externalLink")),dom.$create("ul",urls.map(args=>args&&dom.$create("li",dom.$createLink(...args))).filter(Boolean))])}()),getAppliesTo().then(list=>replaceChildren(s.querySelector(".applies-to"),list.map(e=>dom.$create("li",e)))),Object.assign(s.querySelector(".configure-usercss"),{hidden:!data.vars,onclick:openConfigDialog}),data.vars){if(!util.deepEqual(data.vars,vars)){vars=data.vars;for(const[e,t]of Object.entries(dup&&dupData.vars||{})){const s=vars[e];s&&s.type===t.type&&(s.value=t.value)}}}else cfgShown=!1,dom.$$remove(CFG_SEL);function openConfigDialog(){dom_util.configDialog(style)}shouldShowConfig()&&openConfigDialog(),s.getElementById("header").dataset.arrivedFast=performance.now()<500,s.getElementById("header").classList.add("meta-init"),s.getElementById("header").classList.remove("meta-init-error"),setTimeout(()=>dom.$$remove(".lds-spinner"),1e3),showError(""),requestAnimationFrame(adjustCodeHeight),dup&&enablePostActions()}function showError(err){if(s.querySelector(".warnings").textContent="",s.querySelector(".warnings").classList.toggle("visible",Boolean(err)),s.body.classList.toggle("has-warnings",Boolean(err)),(err=Array.isArray(err)?err:[err])[0]){let e;((e=err[0].index)>=0||(e=err[0].offset)>=0)&&(install_usercss_cm.jumpToPos(install_usercss_cm.posFromIndex(e)),install_usercss_cm.setSelections(err.map(e=>{const pos=e.index>=0&&install_usercss_cm.posFromIndex(e.index)||e.offset>=0&&{line:e.line-1,ch:e.col-1};return pos&&{anchor:pos,head:pos}}).filter(Boolean)),install_usercss_cm.focus()),s.querySelector(".warnings").appendChild(dom.$create(".warning",[util.t("parseUsercssError"),"\n",...err.map(e=>e.message?dom.$create("pre",e.message):e||"Unknown error")]))}adjustCodeHeight()}function showBuildError(error){s.getElementById("header").classList.add("meta-init-error"),console.error(error),showError(error)}function install(res){installed=res,dom.$$remove(".warning"),s.querySelector("button.install").disabled=!0,s.querySelector("button.install").classList.add("installed"),s.getElementById("live-reload-install-hint").hidden=!liveReloadEnabled,s.querySelector(".set-update-url").title=style.updateUrl?util.t("installUpdateFrom",style.updateUrl):"",s.querySelectorAll(".install-disable input").forEach(e=>e.disabled=!0),s.body.classList.add("installed"),enablePostActions(),updateMeta(res),liveReloadEnabled&&liveReload()}function enablePostActions(){const{id:e}=installed||dup;util.sessionStore.justEditedStyleId=e,s.getElementById("edit").search=`?id=${e}`,s.getElementById("delete").onclick=async()=>{await dom_util.messageBox.confirm(util.t("deleteStyleConfirm"),"danger center",util.t("confirmDelete"))&&(await msg_api.API.styles.remove(e),tabId<0&&history.length>1?history.back():util_webext.closeCurrentTab())}}async function getAppliesTo(){if(sectionsPromise)try{style.sections=(await sectionsPromise).sections}catch(e){return showBuildError(e),[]}finally{sectionsPromise=null}let numGlobals=0;const res=[],TARGETS=["urls","urlPrefixes","domains","regexps"];for(const section of style.sections){const targets=[].concat(...TARGETS.map(e=>section[e]).filter(Boolean));res.push(...targets),numGlobals+=!targets.length&&!sections_util.styleCodeEmpty(section)}return res.sort(),res.length&&!numGlobals||res.push(util.t("appliesToEverything")),[...new Set(res)]}function adjustCodeHeight(){const scroller=install_usercss_cm.display.scroller,prevWindowHeight=adjustCodeHeight.prevWindowHeight;(scroller.scrollHeight===scroller.clientHeight||prevWindowHeight&&t.innerHeight!==prevWindowHeight)&&(adjustCodeHeight.prevWindowHeight=t.innerHeight,install_usercss_cm.setSize(null,s.querySelector(".main").offsetHeight-s.querySelector(".warnings").offsetHeight))}function initLiveReload(){let timer=!0,sequence=Promise.resolve();return e=>{e&&(liveReloadEnabled=e.target.checked),(installed||dup)&&(liveReloadEnabled?start({force:!0}):stop(),s.querySelector(".install").disabled=liveReloadEnabled,Object.assign(s.getElementById("live-reload-install-hint"),{hidden:!liveReloadEnabled,textContent:util.t("liveReloadInstallHint"+(tabId>=0?"FF":""))}))};async function check(opts){try{update(await getData(opts))}catch(e){console.warn(util.t("liveReloadError",e))}timer&&(timer=setTimeout(check,500))}async function start(opts){if(fsh&&(fso||(fso=e.FileSystemObserver)&&(fso=new fso(()=>util.debounce(check,20)))))try{await fso.observe(fsh),timer=!1}catch{timer=!0}check(opts)}function stop(){timer?timer=clearTimeout(timer):fso&&fso.disconnect()}function update(code){null!=code&&(sequence=sequence.catch(console.error).then(()=>{const{id:e}=installed||dup,scrollInfo=install_usercss_cm.getScrollInfo(),cursor=install_usercss_cm.getCursor();return install_usercss_cm.setValue(code),install_usercss_cm.setCursor(cursor),install_usercss_cm.scrollTo(scrollInfo.left,scrollInfo.top),msg_api.API.usercss.install({id:e,sourceCode:code}).then(updateMeta).catch(showError)}))}}function shouldShowConfig(){const prev=cfgShown;return cfgShown=null!=s.querySelector(CFG_SEL),prev&&!cfgShown}function replaceChildren(e,children,toggleParent){e.firstChild&&(e.textContent=""),children&&e.append(...Array.isArray(children)?children:[children]),toggleParent&&(e.parentNode.hidden=!e.firstChild)}s.on("visibilitychange",()=>{dom.$$remove("#message-box:not(.config-dialog)"),installed&&liveReload()}),localization.tBody(),setTimeout(()=>!install_usercss_cm&&dom_util.showSpinner(s.getElementById("header")),200),async function(){location.hash&&history.replaceState(null,"",location.pathname+"?updateUrl="+encodeURIComponent(location.hash.slice(1)));const params=new URLSearchParams(location.search);let firstGet;if(fsh=t.fsh,tabId=params.has("tabId")?Number(params.get("tabId")):-1,initialUrl=fsh?fsh._url:params.get("updateUrl"),fsh){let oldCode=null;getData=async()=>{const code=await(await fsh.getFile()).text();if(oldCode!==code)return oldCode=code},firstGet=getData()}else initialUrl?tabId<0&&(getData=DirectDownloader(initialUrl),firstGet=msg_api.API.usercss.getInstallCode(initialUrl).then(code=>code||getData()).catch(getData)):history.length>1?history.back():util_webext.closeCurrentTab();const hasFileAccessP=browser.extension.isAllowedFileSchemeAccess(),elSettings=localization.htmlToTemplate(style_settings.default);let error,sourceCode;elSettings.$("#ss-update-url").closest("div").remove(),elSettings.$(".buttons").remove(),s.querySelector(".settings").append(elSettings);try{sourceCode=await firstGet,({dup,style}=await msg_api.API.usercss.build({sourceCode,checkDup:!0,metaOnly:!0})),sectionsPromise=msg_api.API.usercss.buildCode(style)}catch(e){error=e}liveReload=initLiveReload();const[hasFileAccess]=await Promise.all([hasFileAccessP,prefs.ready]);if(!style&&null==sourceCode)return void dom_util.messageBox.alert(isNaN(error)?`${error}`:"HTTP Error "+error,"pre");const theme=prefs.__values[a.THEME_KEY];if(a.loadCmTheme(theme),install_usercss_cm=a.CodeMirror(s.querySelector(".main"),{value:sourceCode||style.sourceCode,readOnly:!0,colorpicker:!0,theme}),t.on("resize",adjustCodeHeight),error&&showBuildError(error),!style)return;const data=style.usercssData,dupData=dup&&dup.usercssData,versionTest=dup&&(0,cmpver.default)(data.version,dupData.version);updateMeta(),dup?(s.querySelector(`[name="ss-scheme"][value="${dup.preferScheme}"]`)||{}).checked=!0:s.querySelector(".live-reload span").textContent=util.t("liveReloadAfterInstall");for(let type of["in","ex"]){const e=s.getElementById("ss-"+(type+="clusions")),list=dup&&dup[type]||[];e.value=list.join("\n")+(list[0]?"\n":""),e.rows=list.length+2,e.onchange=()=>{style[type]=e.value.split(/\n/).map(e=>e.trim()).filter(Boolean)}}versionTest<0&&s.querySelector("h1").after(dom.$create(".warning",util.t("versionInvalidOlder"))),s.querySelector("button.install").onclick=()=>{shouldShowConfig(),(dup?dom_util.messageBox.confirm(dom.$create("span",util.t("styleInstallOverwrite",[data.name+(dup.customName?` (${dup.customName})`:""),dupData.version,data.version]))):Promise.resolve(!0)).then(e=>e&&msg_api.API.usercss.install(style).then(install).catch(err=>dom_util.messageBox.alert(util.t("styleInstallFailed",err.message||err),"pre")))};const checker=s.querySelector(".set-update-url input[type=checkbox]"),updateUrl=util.tryURL(style.updateUrl||initialUrl||dup&&dup.updateUrl);updateUrl?dup&&dup.updateUrl===updateUrl.href?(checker.checked=!0,checker.disabled=!0):("file:"!==updateUrl.protocol||hasFileAccess)&&(checker.checked=!0,style.updateUrl=updateUrl.href):checker.disabled=!0,checker.onchange=()=>{style.updateUrl=checker.checked?updateUrl.href:null},checker.onchange(),s.querySelector(".set-update-url p").textContent=util.clipString(updateUrl.href||"",300),s.getElementById("ss-scheme").onchange=e=>{style.preferScheme=e.target.value},!initialUrl||urls.isLocalhost(initialUrl)?s.querySelector(".live-reload input").onchange=liveReload:s.querySelector(".live-reload").remove()}()}},e=>{e.O(0,["common-ui","codemirror","css_global-dark_css-css_global_css-css_spinner_css"],()=>e(e.s=9050));e.O()}])}