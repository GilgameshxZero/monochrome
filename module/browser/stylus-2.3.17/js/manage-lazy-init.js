"use strict";{const e=self,t=e,n=e.document,a=n.documentElement;(self.webpackChunkStylus=self.webpackChunkStylus||[]).push([["manage_lazy-init_js"],{6560:(e,s,o)=>{var dom=o(7986),dom_util=o(3831),localization=o(7501),i=o(8970),util=o(6940);const CLS_TRANSFORMED="draggable-list-transformed";function posToIndex(rects,startIndex,e,bound){if(e<rects[0].top&&bound)return startIndex;for(let t=0;t<startIndex;t++)if(!(rects[t].bottom<e))return t;if(e>rects[rects.length-1].bottom&&bound)return startIndex;for(let t=rects.length-1;t>startIndex;t--)if(!(rects[t].top>e))return t;return startIndex}function applyTransform(list,startIndex,oldIndex,newIndex,len){function transform(state,e,t,style){for(let n=e;n<=t;n++)state&&!list[n].classList.contains(CLS_TRANSFORMED)?(list[n].classList.add(CLS_TRANSFORMED),list[n].style.transform=style):!state&&list[n].classList.contains(CLS_TRANSFORMED)&&(list[n].classList.remove(CLS_TRANSFORMED),list[n].style="")}newIndex>oldIndex?(transform(!1,oldIndex,Math.min(startIndex-1,newIndex-1)),startIndex<list.length-1&&transform(!0,Math.max(oldIndex+1,startIndex+1),newIndex,`translateY(${-len}px)`)):(transform(!1,Math.max(startIndex+1,newIndex+1),oldIndex),startIndex>0&&transform(!0,newIndex,Math.min(oldIndex-1,startIndex-1),`translateY(${len}px)`))}function DraggableList(e,{bound,scrollContainer}={}){for(const t of e.children)t.draggable=!0;new MutationObserver(records=>{for(const e of records)for(const t of e.addedNodes)t.draggable=!0}).observe(e,{childList:!0});let startPos=null,startIndex=0,dragOverIndex=0,dragOverPos=null,rects=[],dragTarget=null,dropped=!1,itemSize=0;function dispatch(t,name,props){const detail={origin:t,startPos,currentPos:dragOverPos,dragTarget};props&&Object.assign(detail,props),e.dispatchEvent(new CustomEvent(name,{detail}))}e.addEventListener("dragstart",n=>{if(n.target.parentNode!==e)return;dragTarget=n.target,dropped=!1;const scrollTop=scrollContainer?scrollContainer.scrollTop:0;startPos={x:n.pageX+(scrollContainer?scrollContainer.scrollLeft:0),y:n.pageY+scrollTop},startIndex=[...e.children].indexOf(n.target),dragOverIndex=startIndex,dragOverPos=startPos,rects=[...e.children].map(e=>{const n=e.getBoundingClientRect();return{top:n.top+t.scrollY+scrollTop,bottom:n.bottom+t.scrollY+scrollTop}}),itemSize=startIndex+1<rects.length?rects[startIndex+1].top-rects[startIndex].top:startIndex>0?rects[startIndex].bottom-rects[startIndex-1].bottom:0,dragTarget.classList.add("draggable-list-target"),e.classList.add("draggable-list-dragging"),dispatch(n,"d:dragstart")}),e.addEventListener("dragenter",e=>{dragTarget&&(e.preventDefault(),dispatch(e,"d:dragmove"))}),e.addEventListener("dragover",t=>{if(!dragTarget)return;t.preventDefault();const newPos={x:t.pageX+(scrollContainer?scrollContainer.scrollLeft:0),y:t.pageY+(scrollContainer?scrollContainer.scrollTop:0)},newIndex=posToIndex(rects,startIndex,newPos.y,bound);applyTransform(e.children,startIndex,dragOverIndex,newIndex,itemSize),dragOverIndex=newIndex,dragOverPos=newPos,dispatch(t,"d:dragmove")}),n.addEventListener("dragend",t=>{if(dragTarget){for(const t of e.children)t.classList.remove(CLS_TRANSFORMED),t.style="";dragTarget.classList.remove("draggable-list-target"),e.classList.remove("draggable-list-dragging"),dispatch(t,"d:dragend",{originalIndex:startIndex,spliceIndex:dragOverIndex,insertBefore:dragOverIndex<startIndex?e.children[dragOverIndex]:e.children[dragOverIndex+1],dropped}),dragTarget=null}}),e.addEventListener("drop",e=>{dragTarget&&(dropped=!0,e.preventDefault())})}var msg_api=o(4930);let l;var router=o(6677),msg=o(3619),prefs=o(492),storage_util=o(5880),filters=o(5393),sorter=o(8939),manage_util=o(1585);const elAll=localization.template.updateAll,btnApply=elAll.$("#apply-all-updates"),btnCheck=n.getElementById("check-all-updates"),btnCheckForce=elAll.$("#check-all-updates-force"),elNoUpdates=elAll.$("#update-all-no-updates"),elOnlyUpdates=n.getElementById("only-updates");let uiLog;btnCheck.onclick=btnCheckForce.onclick=function(){n.body.classList.add("update-in-progress"),btnCheck.disabled=!0,dom.$detach(btnCheckForce),dom.$detach(btnApply),dom.$detach(elNoUpdates);const ignoreDigest=this===btnCheckForce;n.querySelectorAll(".updatable:not(.can-update)"+(ignoreDigest?"":":not(.update-problem)")).forEach(checkUpdate);let total=0,checked=0,skippedEdited=0,updated=0;function observer(info,port){"count"in info&&(total=info.count),info.updated&&(1===++updated&&(btnApply.disabled=!0),btnApply.dataset.value=updated),(info.updated||"error"in info)&&(checked++,skippedEdited+=!info.updated&&[info.STATES.EDITED,info.STATES.MAYBE_EDITED].includes(info.error),reportUpdateState(info));const progress=n.getElementById("update-progress");progress.style.width=Math.round(checked/total*progress.parentElement.clientWidth)+"px",info.done&&(port.onMessage.removeListener(observer),n.body.classList.remove("update-in-progress"),btnCheck.disabled=0===total,btnApply.disabled=!1,renderUpdatesOnlyFilter({check:updated+skippedEdited>0}),updated||(elNoUpdates.dataset.skippedEdited=skippedEdited>0,dom.$detach(elNoUpdates,!1),dom.$detach(btnCheckForce,!skippedEdited)))}msg.onConnect.updater=port=>port.onMessage.addListener(observer),msg_api.API.updater.checkAllStyles({save:!1,observe:!0,ignoreDigest})},btnApply.onclick=function(){btnApply.disabled=!0,setTimeout(()=>{dom.$detach(btnApply),btnApply.disabled=!1,renderUpdatesOnlyFilter({show:!1})},1e3),n.querySelectorAll(".can-update .update").forEach(button=>{dom_util.scrollElementIntoView(button),button.click()})};for(const e of[...elAll.children])dom.$detach(e);for(const e of["updateAll"])n.querySelector(`template[data-id="${e}"]`).replaceWith(localization.template[e]);{const kBtns="manage.actions.expanded",kOnly="updateOnlyEnabled";prefs.subscribe([kBtns,kOnly],()=>{btnCheck.title=btnCheck.title.split("\n")[0]+(!prefs.__values[kBtns]&&prefs.__values[kOnly]?`\n(${util.t("manageOnlyEnabled")})`:"")},!0)}function checkUpdate(entry,{single}={}){entry.$(".update-note").textContent=util.t("checkingForUpdate"),entry.$(".check-update").title="",single&&msg_api.API.updater.checkStyle({save:!1,id:entry.styleId,ignoreDigest:entry.classList.contains("update-problem")}).then(reportUpdateState),entry.classList.remove("checking-update","no-update","update-problem"),entry.classList.add("checking-update")}function reportUpdateState({updated,style,error,STATES}){const isCheckAll=n.body.classList.contains("update-in-progress"),entry=n.getElementById("style-"+style.id),newClasses={updatable:1,"checking-update":0,"update-done":0,"install-done":0,"no-update":0,"update-problem":0};if(updated)newClasses["can-update"]=!0,entry.updatedCode=style,entry.$(".update-note").textContent="",elOnlyUpdates.classList.remove("hidden");else if(!entry.classList.contains("can-update")){const same=error===STATES.SAME_MD5||error===STATES.SAME_CODE||error===STATES.SAME_VERSION,edited=error===STATES.EDITED||error===STATES.MAYBE_EDITED;error?"number"==typeof error?error=util.t("updateCheckFailBadResponseCode",[error])+"\n"+style.updateUrl:error===STATES.EDITED?error=util.t("updateCheckSkippedLocallyEdited")+"\n"+util.t("updateCheckManualUpdateHint"):error===STATES.MAYBE_EDITED?error=util.t("updateCheckSkippedMaybeLocallyEdited")+"\n"+util.t("updateCheckManualUpdateHint"):"object"==typeof error&&error.message?error=error.message:Array.isArray(error)&&(error=error.map(e=>`${e.message||e}${e.context?"\n"+e.context.replace(/^/gm,"\t"):""}`).join("\n")):error=util.t("updateCheckFailServerUnreachable")+"\n"+style.updateUrl,entry.dataset.error=error;const message=same?util.t("updateCheckSucceededNoUpdate"):error;if(newClasses["no-update"]=!0,newClasses["update-problem"]=!same,entry.$(".update-note").textContent=message,entry.$(".check-update").title=manage_util.newUI.cfg.enabled?message:"",entry.$(".update").title=util.t(edited?"updateCheckManualUpdateForce":"installUpdate"),error===STATES.SAME_CODE)for(const view of chrome.extension.getViews({type:"tab"}))if(view.location.pathname===location.pathname){const e=view["style-"+style.id];e&&(e.styleMeta.originalDigest=style.originalDigest)}isCheckAll||renderUpdatesOnlyFilter({show:n.querySelector(".can-update, .update-problem")})}dom.$toggleClasses(entry,newClasses),filters.filtersSelector.hide&&isCheckAll?filters.filterAndAppend({entry}).then(sorter.updateStripes):updated&&!isCheckAll&&renderUpdatesOnlyFilter()}function renderUpdatesOnlyFilter({show,check}={}){const numUpdatable=n.querySelectorAll(".can-update").length,mightUpdate=numUpdatable>0||n.querySelector(".update-problem"),checkbox=elOnlyUpdates.$("input");show=void 0!==show?show:mightUpdate,check=void 0!==check?show&&check:checkbox.checked&&mightUpdate,elOnlyUpdates.classList.toggle("hidden",!show),checkbox.checked=check&&show,checkbox.dispatchEvent(new Event("change")),dom.$detach(btnApply,!numUpdatable),btnApply.dataset.value=numUpdatable}function handleUpdateInstalled(entry,reason){const isNew="install"===reason,note=util.t(isNew?"installButtonInstalled":"updateCompleted");entry.classList.add("update-done",...isNew?["install-done"]:[]),entry.classList.remove("can-update","updatable"),entry.$(".update-note").textContent=note,entry.$(".updated").title=note,renderUpdatesOnlyFilter()}var util_webext=o(1480),render=o(9168);for(const e of n.querySelectorAll('#header a[href^="http"]'))e.onclick=openLink;manage_util.installed.on("click",onEntryClicked),manage_util.installed.on("contextmenu",onEntryClicked),t.on("pageshow",handleVisibilityChange),t.on("pagehide",handleVisibilityChange),msg.onMessage.set(e=>{switch(e.method){case"styleUpdated":case"styleAdded":case"styleDeleted":manage_util.queue.push(e),manage_util.queue.p??=Promise.resolve().then(handleBulkChange)}});const SEL_EXPANDER=".applies-to .expander",ENTRY_ROUTES={"input, .enable, .disable"(event,entry){msg_api.API.styles.toggle(entry.styleId,this.matches(".enable")||this.checked)},".style-name"(event,entry){manage_util.newUI.cfg.enabled&&!event.target.closest(".homepage")&&edit(event,entry)},".homepage":openLink,".check-update"(event,entry){checkUpdate(entry,{single:!0})},".update"(event,entry){const json=entry.updatedCode;json.id=entry.styleId,(json.usercssData?msg_api.API.usercss.install:msg_api.API.styles.install)(json)},async".delete"(event,entry){const e=entry.styleId;dom_util.animateElement(entry);const{button}=await dom_util.messageBox.show({title:util.t("deleteStyleConfirm"),contents:entry.styleMeta.customName||entry.styleMeta.name,className:"danger center",buttons:[util.t("confirmDelete"),util.t("confirmCancel")]});0===button&&msg_api.API.styles.remove(e),dom_util.setHocus(n.querySelector("#message-box-buttons > button"),!1)},".configure-usercss"(event,{styleId}){dom_util.configDialog(styleId)},[SEL_EXPANDER]:expandTargets},ENTRY_ROUTES_CTX={[SEL_EXPANDER]:expandTargets};async function edit(event,entry){if(event.altKey)return;event.preventDefault(),event.stopPropagation();const key=dom_util.getEventKeyName(event),url=entry.$("[href]").href,ownTab=await util_webext.getOwnTab();"MouseL"===key?(util.sessionStore["manageStylesHistory"+ownTab.id]=url,location.href=url):util_webext.browserWindows&&"Shift-MouseL"===key?msg_api.API.openEditor({id:entry.styleId}):msg_api.API.openURL({url,index:ownTab.index+1,active:"Shift-MouseM"===key||"Shift-Ctrl-MouseL"===key})}function expandTargets(event,entry){if("contextmenu"===event.type){event.preventDefault();const e=".expanded";return void n.querySelectorAll(`.has-more${entry.$(e)?e:`:not(${e})`} .expander`).forEach(e=>e.click())}entry._allTargetsRendered||(render.createTargetsElement({entry,expanded:!0}),render.renderFavs(entry)),this.closest(".applies-to").classList.toggle("expanded")}async function openLink(event){if("Shift-MouseL"!==dom_util.getEventKeyName(event)){event.preventDefault();const{index}=await util_webext.getOwnTab();msg_api.API.openURL({url:event.target.closest("a").href,index:index+1,active:!event.ctrlKey||event.shiftKey})}}function onEntryClicked(event){const target=event.target,entry=target.closest(".entry"),routes="contextmenu"===event.type?ENTRY_ROUTES_CTX:ENTRY_ROUTES;for(const selector in routes)for(let e=target;e&&e!==entry;e=e.parentElement)if(e.matches(selector))return routes[selector].call(e,event,entry)}function handleBulkChange(){for(const msg of manage_util.queue){const{id:e}=msg.style;let fullStyle;"styleDeleted"===msg.method?handleDelete(e):"import"===msg.reason&&(fullStyle=manage_util.queue.styles.get(e))?(handleUpdate(fullStyle,msg),manage_util.queue.styles.delete(e)):handleUpdateForId(e,msg)}sorter.updateStripes({onlyWhenColumnsChanged:!0}),manage_util.queue.p=null,manage_util.queue.length=0}function handleDelete(e){const node=n.getElementById("style-"+e);if(node){if(node.remove(),node.matches(".can-update")){const btnApply=n.getElementById("apply-all-updates");btnApply.dataset.value=Number(btnApply.dataset.value)-1}filters.showFiltersStats(),render.updateTotal(-1)}}function handleUpdate(style,{reason,method}={}){if("editPreview"===reason||"editPreviewEnd"===reason)return;let entry,oldEntry=n.getElementById("style-"+style.id);oldEntry&&"styleUpdated"===method&&function(){const diff=manage_util.objectDiff(oldEntry.styleMeta,style).filter(({key,path})=>path||!/^_|(Date|Digest|Md5)$/.test(key));0===diff.length&&(entry=oldEntry,oldEntry=null);if(1===diff.length&&"enabled"===diff[0].key){const isOn=style.enabled;dom.$toggleClasses(oldEntry,{enabled:isOn,disabled:!isOn});for(const e of oldEntry.$$("input"))e.checked=isOn;oldEntry.styleMeta=style,entry=oldEntry,oldEntry=null}}(),entry=entry||render.createStyleElement(manage_util.styleToDummyEntry(style)),oldEntry?oldEntry.styleNameLC===entry.styleNameLC?manage_util.installed.replaceChild(entry,oldEntry):oldEntry.remove():render.updateTotal(1),"update"!==reason&&"install"!==reason||!entry.matches(".updatable")||handleUpdateInstalled(entry,reason),filters.filterAndAppend({entry}).then(sorter.update),entry.matches(".hidden")||"import"===reason||"sync"===reason||(dom_util.animateElement(entry),requestAnimationFrame(()=>dom_util.scrollElementIntoView(entry))),render.renderFavs(entry)}async function handleUpdateForId(e,opts){handleUpdate(await msg_api.API.styles.getCore({id:e,sections:!0,size:!0}),opts)}function handleVisibilityChange(e){const a=Number(util.sessionStore.justEditedStyleId);"pageshow"===e.type&&e.persisted&&a?(handleUpdateForId(a,{method:"styleUpdated"}),delete util.sessionStore.justEditedStyleId):"pagehide"===e.type&&history.replaceState({scrollY:t.scrollY},n.title)}var chrome_sync=o(7033),sections_util=o(2013);async function importFromFile(file){let resolve,reject;const e=n.createElement("input"),textPromise=new Promise((...args)=>[resolve,reject]=args);try{file?readFile():(e.style.display="none",e.type="file",e.accept="application/json"+(i.MOBILE?",text/plain":""),e.acceptCharset="utf-8",n.body.appendChild(e),e.initialValue=e.value,e.onchange=readFile,e.click());const text=await textPromise;if(e.remove(),/^\s*\[/.test(text))await importFromString(text),setTimeout(()=>manage_util.queue.styles.clear(),200);else if(util.RX_META.test(text))throw util.t("dragDropUsercssTabstrip")}catch(e){dom_util.messageBox.alert(e.message||e)}function readFile(){if(!file){if(e.value===e.initialValue)return resolve("");file=e.files[0]}if(file.size>1e9)return reject((file.size/1e9).toFixed(1).replace(".0","")+"GB backup? I don't believe you.");const t=new FileReader;t.onloadend=()=>resolve(t.result),t.onerror=reject,t.readAsText(file,"utf-8")}}async function importFromString(jsonString){const json=JSON.parse(jsonString),oldStyles=Array.isArray(json)&&json.length?await msg_api.API.styles.getAll():[],oldStylesById=new Map(oldStyles.map(style=>[style.id,style])),oldStylesByUuid=new Map(oldStyles.map(style=>[style._id,style])),oldStylesByName=new Map(oldStyles.map(style=>[style.name.trim(),style])),oldOrder=await msg_api.API.styles.getOrder(),items=[],INFO=Symbol("info"),stats={options:{names:[],isOptions:!0,legend:"optionsHeading"},added:{names:[],ids:[],legend:"importReportLegendAdded",dirty:!0},unchanged:{names:[],ids:[],legend:"importReportLegendIdentical"},metaAndCode:{names:[],ids:[],legend:"importReportLegendUpdatedBoth",dirty:!0},metaOnly:{names:[],ids:[],legend:"importReportLegendUpdatedMeta",dirty:!0},codeOnly:{names:[],ids:[],legend:"importReportLegendUpdatedCode",dirty:!0},invalid:{names:[],legend:"importReportLegendInvalid"}};let order;await Promise.all(json.map(function(item,index){if(item&&!item.id&&item[prefs.STORAGE_KEY])return analyzeStorage(item);if(!item||"object"!=typeof item||(util.isEmptyObj(item.usercssData)?!sections_util.styleJSONseemsValid(item):"string"!=typeof item.sourceCode))return void stats.invalid.names.push(`#${index}: ${util.clipString(item&&item.name||"")}`);item.name=item.name.trim();const byId=oldStylesById.get(item.id),byUuid=oldStylesByUuid.get(item._id),byName=oldStylesByName.get(item.name);oldStylesByName.delete(item.name);let oldStyle=byUuid;!oldStyle&&byId&&(sameStyle(byId,item)?oldStyle=byId:delete item.id);!oldStyle&&byName&&(item.id=byName.id,oldStyle=byName);const metaEqual=oldStyle&&util.deepEqual(oldStyle,item,["sections","sourceCode","_rev"]),codeEqual=oldStyle&&sameCode(oldStyle,item);if(metaEqual&&codeEqual)stats.unchanged.names.push(oldStyle.name),stats.unchanged.ids.push(oldStyle.id);else{const e=items.length-1,group=items[e];(!group||group.length>=30?items[e+1]=[]:group).push(item),item[INFO]={oldStyle,metaEqual,codeEqual}}}));for(const group of items){const styles=await msg_api.API.styles.importMany(group);for(let e=0;e<styles.length;e++){const{style,err}=styles[e],item=group[e];style&&manage_util.queue.styles.set(style.id,style),updateStats(style||item,item[INFO],err)}}return await msg_api.API.styles.setOrder(order),async function(){scrollTo(0,0);const entries=Object.entries(stats),numChanged=entries.reduce((sum,[,val])=>sum+(val.dirty?val.names.length:0),0),report=entries.map(renderStats).filter(Boolean),{button}=await dom_util.messageBox.show({title:util.t("importReportTitle"),className:"center-dialog",contents:dom.$create("#import",report.length?report:util.t("importReportUnchanged")),buttons:[util.t("confirmClose"),numChanged&&util.t("undo")],onshow:bindClick});1===button&&undo()}();async function analyzeStorage(storage){analyzePrefs(storage[prefs.STORAGE_KEY],prefs.knownKeys,prefs.__values,!0),delete storage[prefs.STORAGE_KEY],order=storage.order,delete storage.order,util.isEmptyObj(storage)||analyzePrefs(storage,Object.values(chrome_sync.LZ_KEY),await chrome_sync.getLZValues())}function analyzePrefs(obj,validKeys,values,isPref){for(const[key,val]of Object.entries(obj||{})){const isValid=validKeys.includes(key);isValid&&util.deepEqual(val,values[key])||stats.options.names.push({name:key,val,isValid,isPref})}}function sameCode(oldStyle,newStyle){const e=oldStyle.usercssData,t=newStyle.usercssData;return!e+!t?sections_util.styleSectionsEqual(oldStyle,newStyle):oldStyle.sourceCode===newStyle.sourceCode&&util.deepEqual(e.vars,t.vars)}function sameStyle(oldStyle,newStyle){return oldStyle.name.trim()===newStyle.name.trim()||["updateUrl","originalMd5","originalDigest"].some(field=>oldStyle[field]&&oldStyle[field]===newStyle[field])}function updateStats(style,{oldStyle,metaEqual,codeEqual},err){return err?(err=(Array.isArray(err)?err:[err]).map(e=>e.message||e).join(", "),void stats.invalid.names.push(style.name+" - "+err)):oldStyle?metaEqual||codeEqual?codeEqual?(stats.metaOnly.names.push(reportNameChange(oldStyle,style)),void stats.metaOnly.ids.push(style.id)):(stats.codeOnly.names.push(style.name),void stats.codeOnly.ids.push(style.id)):(stats.metaAndCode.names.push(reportNameChange(oldStyle,style)),void stats.metaAndCode.ids.push(style.id)):(stats.added.names.push(style.name),void stats.added.ids.push(style.id))}function renderStats([e,{ids,names,legend,isOptions}]){if(!names.length)return;let btn;return isOptions&&names.some(e=>e.isValid)&&(btn=dom.$create("button",util.t("importLabel")),importOptions.call(btn)),dom.$create(`details[data-id=${e}]`,{open:isOptions},[dom.$create("summary",dom.$create("b",(isOptions?"":names.length+" ")+util.t(legend))),dom.$create("small",names.map(ids?listItemsWithId:isOptions?listOptions:listItems,ids)),btn].filter(Boolean))}function listOptions({name,isValid}){const e=n.createElement(isValid?"div":"del");return e.textContent=name+(isValid?"":` (${util.t(stats.invalid.legend)})`),e}function listItems(name){const e=n.createElement("div");return e.textContent=name,e}function listItemsWithId(name,e){const t=n.createElement("div");return t.textContent=name,t.dataset.id=this[e],t}async function importOptions(){const oldStorage=await chrome_sync.get(),e={};for(const{name,val,isValid,isPref}of stats.options.names)isValid&&(isPref?prefs.set(name,val):e[name]=val);chrome_sync.setLZValues(e);const label=this.textContent;return this.textContent=util.t("undo"),this.onclick=async()=>{const keysToRemove=Object.keys(await chrome_sync.get()).filter(e=>!util.hasOwn(oldStorage,e));await chrome_sync.set(oldStorage),await chrome_sync.remove(keysToRemove),this.textContent=label,this.onclick=importOptions},this}async function undo(){const newIds=[...stats.metaAndCode.ids,...stats.metaOnly.ids,...stats.codeOnly.ids,...stats.added.ids];await Promise.all(newIds.map(e=>msg_api.API.styles.remove(e))),await msg_api.API.styles.importMany(newIds.map(e=>oldStylesById.get(e)).filter(Boolean)),await msg_api.API.styles.setOrder(oldOrder),await dom_util.messageBox.show({title:util.t("importReportUndoneTitle"),contents:newIds.length+" "+util.t("importReportUndone"),buttons:[util.t("confirmClose")]})}function bindClick(){const highlightElement=event=>{const styleElement=n.getElementById("style-"+event.target.dataset.id);styleElement&&(dom_util.scrollElementIntoView(styleElement),dom_util.animateElement(styleElement))};for(const block of n.querySelectorAll("#message-box details"))"invalid"!==block.dataset.id&&(block.style.cursor="pointer",block.onclick=highlightElement)}function reportNameChange(oldStyle,newStyle){return newStyle.name!==oldStyle.name?oldStyle.name+" —> "+newStyle.name:oldStyle.name}}async function exportToFile(e){e.preventDefault();const keepDupSections="contextmenu"===e.type||e.shiftKey||"compat"===e.detail,data=[Object.assign({[prefs.STORAGE_KEY]:prefs.__values,order:await msg_api.API.styles.getOrder()},await chrome_sync.getLZValues()),...(await msg_api.API.styles.getAll()).map(function(style){const copy={};for(let[key,val]of Object.entries(style))("sections"===key?!style.usercssData||keepDupSections||(val=[{code:""}]):"object"!=typeof val||!util.isEmptyObj(val))&&(copy[key]=val);return copy})],text=JSON.stringify(data,null,"  "),type="application/json";dom.$create("a",{href:URL.createObjectURL(new Blob([text],{type})),download:function(){const today=new Date,e=("0"+today.getDate()).substr(-2),t=("0"+(today.getMonth()+1)).substr(-2);return`stylus-${today.getFullYear()}-${t}-${e}.json`}(),type}).dispatchEvent(new MouseEvent("click"))}let prevText,focusedLink,focusedEntry;Object.assign(n.getElementById("export"),{onclick:exportToFile,oncontextmenu:exportToFile}).on("split-btn",exportToFile),n.getElementById("import").onclick=()=>importFromFile(),Object.assign(n.body,{ondragover(event){const hasFiles=event.dataTransfer.types.includes("Files");event.dataTransfer.dropEffect=hasFiles||"search"===event.target.type?"copy":"none",this.classList.toggle("dropzone",hasFiles),hasFiles&&(event.preventDefault(),this.classList.remove("fadeout"))},ondragend(){dom_util.animateElement(this,"fadeout","dropzone")},ondragleave(event){try{event.target===this&&this.ondragend()}catch{this.ondragend()}},ondrop(event){if(event.dataTransfer.files.length){event.preventDefault();const elOnly=n.querySelector("#only-updates input");elOnly?.checked&&elOnly.click(),importFromFile(event.dataTransfer.files[0])}setTimeout(()=>this.ondragend(),250)}});let prevTime=performance.now(),focusedName="";const input=dom.$create("textarea",{id:"incremental-search",spellcheck:!1,tabIndex:-1,oninput:incrementalSearch});function incrementalSearch(event,immediately){const{key}=event;if(!immediately)return void util.debounce(incrementalSearch,100,{},!0);const direction="ArrowUp"===key?-1:"ArrowDown"===key?1:0,text=input.value.toLocaleLowerCase();if(direction&&event.preventDefault(),!text.trim()||!direction&&(text===prevText||focusedName.startsWith(text)))return void(prevText=text);let rotated,textAtPos=1e6;const entries=[...n.getElementById("message-box")?n.querySelectorAll(".injection-order-entry"):manage_util.installed.children],focusedIndex=entries.indexOf(focusedEntry);let found;focusedIndex>0&&(direction>0?rotated=entries.slice(focusedIndex+1).concat(entries.slice(0,focusedIndex+1)):direction<0&&(rotated=entries.slice(0,focusedIndex).reverse().concat(entries.slice(focusedIndex).reverse())));for(const entry of rotated||entries){if(entry.classList.contains("hidden"))continue;const pos=entry.styleNameLC.indexOf(text);if(0===pos){found=entry;break}if(pos>0&&(pos<textAtPos||direction)&&(found=entry,textAtPos=pos,direction))break}return found&&found!==focusedEntry?(focusedEntry=found,focusedLink=found.$("a"),focusedName=found.styleNameLC,dom_util.scrollElementIntoView(found,{invalidMarginRatio:.25}),dom_util.animateElement(found,"highlight-quick"),replaceInlineStyle({width:focusedLink.offsetWidth+"px",height:focusedLink.offsetHeight+"px",opacity:"1"}),focusedLink.prepend(input),input.focus(),!0):void 0}function replaceInlineStyle(css){for(const prop in css)input.style.setProperty(prop,css[prop],"important")}function addEntryTitle(link){const style=link.closest(".entry").styleMeta,{installDate:dIns,updateDate:dUpd,usercssData:ucd}=style;link.title=[dUpd||dIns?`${localization.formatRelativeDate(dUpd||dIns)}`:"",`${util.t("dateInstalled")}: ${localization.formatDate(dIns,!0)||"—"}`,`${util.t("dateUpdated")}: ${localization.formatDate(dUpd,!0)||"—"}`,ucd?`UserCSS, v.${ucd.version}`:""].filter(Boolean).join("\n")}function lazyAddEntryTitle({type,target}){const cell=target.closest("h2.style-name, [data-type=age]");if(cell){const link=cell.$(".style-name-link")||cell;"mouseover"!==type||link.title?util.debounce.unregister(addEntryTitle):util.debounce(addEntryTitle,50,link)}}replaceInlineStyle({opacity:"0"}),n.body.appendChild(input),t.on("keydown",function(event){if(event.altKey||event.metaKey)return;const modal=n.getElementById("message-box");if(modal&&!modal.classList.contains("injection-order"))return;const inTextInput=dom.$isTextInput(event.target),{key,code,ctrlKey:ctrl}=event;if("KeyF"===code&&ctrl&&!event.shiftKey||("Slash"===code||"/"===key)&&!ctrl&&!inTextInput)return event.preventDefault(),void(modal||n.getElementById("search").focus());if(ctrl||inTextInput&&event.target!==input)return;const time=performance.now();1===key.length?(time-prevTime>1e3&&(input.value="")," "!==key||input.value?(input.focus(),prevTime=time):input.blur()):"Enter"===key&&focusedLink?focusedLink.dispatchEvent(new MouseEvent("click",{bubbles:!0})):("ArrowUp"===key||"ArrowDown"===key)&&!event.shiftKey&&time-prevTime<5e3&&incrementalSearch(event,!0)?prevTime=time:event.target===input&&((focusedLink||n.body).focus(),input.value="")},!0),manage_util.installed.on("mouseover",lazyAddEntryTitle,{passive:!0}),manage_util.installed.on("mouseout",lazyAddEntryTitle,{passive:!0}),router.makeToggle("#manage-options-button, #sync-styles","stylus-options",async function(show,e,selector,toggler){n.title=util.t(show?"optionsHeading":"styleManager"),show?((e=a.appendChild(dom.$create("iframe"+selector))).focus(),e.contentWindow.location="/options.html#"+toggler.id,await new Promise(resolve=>t.closeOptions=resolve)):(await dom_util.animateElement(e,"fadeout"),e.remove())}),router.makeToggle("#injection-order-button","injection-order",async function(show,e,selector){if(!show)return await(l?.close()),void(l=null);const SEL_ENTRY=".injection-order-entry",[groups]=await Promise.all([msg_api.API.styles.getAllOrdered(["_id","id","name","enabled"]),o.e("manage_injection-order_css").then(o.bind(o,6028))]),ols={},parts={},entry=dom.$create("li"+SEL_ENTRY,[parts.name=dom.$create("a",{target:"_blank",draggable:!1}),dom.$create("a.injection-order-toggle",{tabIndex:0,draggable:!1,title:util.t("styleInjectionImportance")})]);function makeEntry(style){return entry.classList.toggle("enabled",style.enabled),parts.name.href="/edit.html?id="+style.id,parts.name.textContent=style.name,Object.assign(entry.cloneNode(!0),{styleNameLC:style.name.toLocaleLowerCase()})}await dom_util.messageBox.show({title:util.t("styleInjectionOrder"),contents:dom.$createFragment(Object.entries(groups).map(function([type,styles]){const ids=groups[type]=styles.map(e=>e._id),e=ols[type]=dom.$create("ol.scroller");let maxTranslateY;return e.append(...styles.map(makeEntry)),e.on("d:dragstart",({detail:t})=>{t.origin.dataTransfer.setDragImage(new Image,0,0),maxTranslateY=e.scrollHeight+e.offsetTop-t.dragTarget.offsetHeight-t.dragTarget.offsetTop}),e.on("d:dragmove",({detail:e})=>{e.origin.stopPropagation(),e.origin.dataTransfer.dropEffect="move";const t=Math.min(e.currentPos.y-e.startPos.y,maxTranslateY);e.dragTarget.style.transform=`translateY(${t}px)`}),e.on("d:dragend",({detail:t})=>{const[item]=ids.splice(t.originalIndex,1);ids.splice(t.spliceIndex,0,item),e.insertBefore(t.dragTarget,t.insertBefore),msg_api.API.styles.setOrder(groups)}),e.on("click",e=>{if(e.target.closest(".injection-order-toggle")){const elEntry=e.target.closest(SEL_ENTRY),t=[].indexOf.call(elEntry.parentNode.children,elEntry),[item]=ids.splice(t,1),type2="main"===type?"prio":"main";groups[type2].push(item),ols[type2].appendChild(elEntry),msg_api.API.styles.setOrder(groups)}}),DraggableList(e,{scrollContainer:e}),dom.$create(`section[data-${type}]`,[dom.$create("header",util.t("styleInjectionOrderHint"+("main"===type?"":"_"+type))),e])})),className:"center-dialog "+selector.slice(1),blockScroll:!0,buttons:[util.t("confirmClose")],onshow(){l=this}})}),router.makeToggle("#update-history-button","update-history",async function(show,e,selector){if(!show)return await(uiLog?.close()),void(uiLog=null);const log=dom.$create(selector);let scroller,toggler,deleted=!1;const[lines=[],states]=await Promise.all([storage_util.chromeLocal.getValue("updateLog"),msg_api.API.updater.getStates()]),logText=lines.join("\n");function scrollToBottom(){scroller.scrollTop=1e9}function calcScrollRatio(){return(scroller.scrollTop+scroller.clientHeight)/scroller.scrollHeight}function toggleSkipped(){if(deleted)return;const scrollRatio=calcScrollRatio();log.textContent=this.checked?logText.replace(this.rxRemoveNOP,""):logText,Math.abs(scrollRatio-calcScrollRatio())>.1&&(scroller.scrollTop=scrollRatio*scroller.scrollHeight-scroller.clientHeight)}await dom_util.messageBox.show({title:util.t("updateCheckHistory"),className:"center-dialog",contents:log,blockScroll:!0,buttons:[util.t("confirmOK"),logText&&{textContent:util.t("confirmDelete"),onclick:function(){deleted?(storage_util.chromeLocal.set({updateLog:logText.split("\n")}),setTimeout(scrollToBottom)):(storage_util.chromeLocal.remove("updateLog"),log.textContent="");deleted=!deleted,toggler.onchange(),this.textContent=util.t(deleted?"undo":"confirmDelete")}}],onshow:logText&&function(box){uiLog=this,scroller=box.$("#message-box-contents"),scroller.tabIndex=0,setTimeout(()=>scroller.focus()),scrollToBottom(),box.$("#message-box-buttons button").insertAdjacentElement("afterend",dom.$create("label",[toggler=dom.$create("input",{type:"checkbox",checked:!0,onchange:toggleSkipped}),util.t("manageOnlyUpdates")])),toggler.rxRemoveNOP=new RegExp("^[^#]*("+Object.keys(states).filter(e=>e.startsWith("SAME_")).map(e=>states[e]).join("|")+").*\r?\n","gm"),toggler.onchange()}})}),router.update()}}])}