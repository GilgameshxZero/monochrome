#!/usr/bin/env bash
# Downloads audio from a link (or uses an existing file), and normalizes for prototype format.
# `prototype` format is `opus` VBR 96kb/s at compression level 10, with the peak volume normalized to 0 dB.
# $1: `audio` or `video`.
# $2: link or filename, e.g. "https://www.youtube.com/watch?v=r6sGWTCMz2k".
# $3: opus target bitrate in kb/s (default: 96 for audio, 48 for video).
# $4: av1 target bitrate in kb/s (default: 500).
# $5: video maximum square pixel count (default: 1280).
# $6: video maximum fps (default: 30).
# $7: av1 preset (default: 4).
set -e
av1_tbr=${4:-500}
resolution_max_video=${5:-1280}
fps_max_video=${6:-30}
av1_preset=${7:-4}
if [ "$1" = "audio" ]; then
	bitrate_audio=${3:-96}
	if [ -f "$2" ]; then
		filename_old=$2
		filename_int=.${2%.*}.tmp.opus
		filename_new=${2%.*}.opus
	else
		filename=$(yt-dlp \
			--extract-audio \
			--output "%(uploader)s-%(title)s" \
			--restrict-filenames \
			--windows-filenames \
			--format bestaudio \
			--cookies-from-browser chromium \
			--js-runtimes node \
			--remote-components ejs:github \
			--no-playlist \
			--print filename \
			"$2" | tail -1)
		# Use old.tmp here to avoid opus conflict after extracting audio.
		yt-dlp \
			--extract-audio \
			--output ".%(uploader)s-%(title)s.old.tmp" \
			--restrict-filenames \
			--windows-filenames \
			--format bestaudio \
			--cookies-from-browser chromium \
			--js-runtimes node \
			--remote-components ejs:github \
			--no-playlist \
			"$2"
		filename_old=$(ls .$filename.old.tmp*)
		filename_int=.$filename.tmp.opus
		filename_new=$filename.opus
	fi
	exec 3>&1
	max_volume_out=$(ffmpeg \
		-i "$filename_old" \
		-filter:a "volumedetect" \
		-map 0:a \
		-f null - |& tee /dev/fd/3)
	# echo must be quoted to preserve newlines.
	max_volume=$(echo "$max_volume_out" \
		| awk -F': ' '/max_volume/ {print $2; exit;}' \
		| awk '{print int($1);}')
	# `channel_layouts` fix taken from <https://trac.ffmpeg.org/ticket/5718#comment:11>.
	ffmpeg \
		-y \
		-i "$filename_old" \
		-c:a libopus \
		-b:a ${bitrate_audio}k \
		-filter:a "aformat=channel_layouts=7.1|5.1|stereo, volume=$((-max_volume)) dB" \
		"$filename_int"
	if [ ! -f "$2" ]; then
		rm "$filename_old"
	fi
	opustags -D -i "$filename_int"
	mv "$filename_int" "$filename_new"
elif [ "$1" = "video" ]; then
	bitrate_audio=${3:-48}
	if [ -f "$2" ]; then
		filename_old=$2
		filename_int=.${2%.*}.tmp.mkv
		filename_new=${2%.*}.mkv
	else
		filename=$(yt-dlp \
			--output "%(uploader)s-%(title)s" \
			--restrict-filenames \
			--windows-filenames \
			--cookies-from-browser chromium \
			--js-runtimes node \
			--remote-components ejs:github \
			--no-playlist \
			--print filename \
			"$2" | tail -1)
		yt-dlp \
			--output ".%(uploader)s-%(title)s.old.tmp" \
			--restrict-filenames \
			--windows-filenames \
			--cookies-from-browser chromium \
			--js-runtimes node \
			--remote-components ejs:github \
			--no-playlist \
			"$2"
		filename_old=$(ls .$filename.old.tmp*)
		filename_int=.$filename.tmp.mkv
		filename_new=$filename.mkv
	fi
	exec 3>&1
	max_volume_out=$(ffmpeg \
		-i "$filename_old" \
		-filter:a "volumedetect" \
		-map 0:a \
		-f null - |& tee /dev/fd/3)
	max_volume=$(echo "$max_volume_out" \
		| awk -F': ' '/max_volume/ {print $2; exit;}' \
		| awk '{print int($1);}')
	# Size filter from <https://stackoverflow.com/questions/54063902/resize-videos-with-ffmpeg-keep-aspect-ratio>.
	# More advanced usage requires the SVT-AV1 binary for `bias-pct` and `passes`.
	ffmpeg \
		-y \
		-i "$filename_old" \
		-map 0 \
		-c:a libopus \
		-b:a ${bitrate_audio}k \
		-filter:a "aformat=channel_layouts=7.1|5.1|stereo, volume=$((-max_volume)) dB" \
		-c:v libsvtav1 \
		-fps_mode cfr \
		-fpsmax $fps_max_video \
		-preset $av1_preset \
		-svtav1-params rc=1:tbr=$av1_tbr:lookahead=120\
		-filter:v "scale=if(gte(iw\,ih)\,min(${resolution_max_video}\,iw)\,-2):if(lt(iw\,ih)\,min(${resolution_max_video}\,ih)\,-2)" \
		"$filename_int"
	# Fixes error <https://github.com/mpv-player/mpv/issues/14969>.
	mkvmerge -o "$filename_new" "$filename_int"
	rm "$filename_int"
	if [ ! -f "$2" ]; then
		rm "$filename_old"
	fi
fi
